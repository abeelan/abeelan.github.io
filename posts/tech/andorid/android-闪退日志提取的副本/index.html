<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android - 闪退日志提取 | ABEE</title><meta name=keywords content="android"><meta name=description content="安卓手机测试过程中，遇到应用闪退，通常需要在 BUG 信息上附加崩溃日志，便于开发同学快速定位问题。"><meta name=author content="ABEE"><link rel=canonical href=https://abeelan.github.io/posts/tech/andorid/android-%E9%97%AA%E9%80%80%E6%97%A5%E5%BF%97%E6%8F%90%E5%8F%96%E7%9A%84%E5%89%AF%E6%9C%AC/><link crossorigin=anonymous href=/assets/css/stylesheet.fbe782675a7c7c9c739a48204d6d2a4da78a00e11ba93326b39891e3501b1740.css integrity="sha256-++eCZ1p8fJxzmkggTW0qTaeKAOEbqTMms5iR41AbF0A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abeelan.github.io/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abeelan.github.io/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://abeelan.github.io/img/favicon.ico><link rel=apple-touch-icon href=https://abeelan.github.io/img/favicon.ico><link rel=mask-icon href=https://abeelan.github.io/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><meta property="og:title" content="Android - 闪退日志提取"><meta property="og:description" content="安卓手机测试过程中，遇到应用闪退，通常需要在 BUG 信息上附加崩溃日志，便于开发同学快速定位问题。"><meta property="og:type" content="article"><meta property="og:url" content="https://abeelan.github.io/posts/tech/andorid/android-%E9%97%AA%E9%80%80%E6%97%A5%E5%BF%97%E6%8F%90%E5%8F%96%E7%9A%84%E5%89%AF%E6%9C%AC/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-21T15:35:52+08:00"><meta property="article:modified_time" content="2021-01-21T15:35:52+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android - 闪退日志提取"><meta name=twitter:description content="安卓手机测试过程中，遇到应用闪退，通常需要在 BUG 信息上附加崩溃日志，便于开发同学快速定位问题。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚 分类","item":"https://abeelan.github.io/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://abeelan.github.io/posts/tech/"},{"@type":"ListItem","position":3,"name":"Android - 闪退日志提取","item":"https://abeelan.github.io/posts/tech/andorid/android-%E9%97%AA%E9%80%80%E6%97%A5%E5%BF%97%E6%8F%90%E5%8F%96%E7%9A%84%E5%89%AF%E6%9C%AC/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android - 闪退日志提取","name":"Android - 闪退日志提取","description":"安卓手机测试过程中，遇到应用闪退，通常需要在 BUG 信息上附加崩溃日志，便于开发同学快速定位问题。\n","keywords":["android"],"articleBody":"安卓手机测试过程中，遇到应用闪退，通常需要在 BUG 信息上附加崩溃日志，便于开发同学快速定位问题。\n存储日志命令为： adb logcat -v time  crash_log.log\n这个方法抓到的日志过多，很多都是无用的系统日志或级别过低的打印日志，所以需要做一次过滤，logcat 可以根据日志等级过滤。将日志级别设置为 ERROR，就可以过滤掉一大部分无用信息。\n命令修改为： adb logcat -v time *:E  crash_log.log\n 备注：\n 星号 * 代表日志任意 tag 都只输出 Error 级别以上日志； MacOS 命令行直接使用 *:E 会报错 no matches found: *:E，所以需要添加双引号或转义符来解决：\"*:E\" 或 \\*:E   获取到日志后，会发现，还是存在一部分系统的错误日志，如何再次过滤呢？\n目标：仅需要某个闪退的全部堆栈信息\n思路：\n 通过命令行做第一次过滤，获取到 ERROR 级别的原始日志； 逐行读取日志，如果查找到关键字 FATAL EXCEPTION: main 则代表出现一次闪退，记录该进程 PID 存储到列表内； 判断当 PID 列表非空时，创建日志文件，将该 PID 的所有日志写入到新文件内。  这样就能满足需求了，接下来代码实现，验证效果。\n获取日志 人工操作步骤为：命令行输入命令，获取日志后，Ctrl+C 关闭日志\n代码也一样，实现方法：\n 模拟命令行：subprocess模块 等待日志获取：安卓日志缓冲区一般为64KB，可以通过 time.sleep() 暂停程序 5 秒（可以自定义时间，我是感觉够用了）； Ctrl+C：通过命令杀死 adb logcat 进程  def log_cat(file_path, device=\"\"): \"\"\"获取 adb 日志 \"\"\" command = rf\"adb {device} logcat -v time \\*:E  {file_path}\" subprocess.Popen(command, shell=True) time.sleep(5) try: if platform.system() == \"Darwin\" or \"Linux\": subprocess.call( \"kill -9 $(ps -ef | grep 'adb logcat' | sed -n 1p | awk '{print $2}')\", shell=True ) else: # Windows 不知道能否生效，网上查的这个方法，没有机器测试 subprocess.Popen(\"taskkill /F /IM adb.exe\") except Exception as e: logging.warning(f\"Kill「adb logcat」called Exception，message：{e}\") 统计出现闪退次数 关键字：闪退日志每次出现都会带一行关键字 FATAL EXCEPTION: main，FATAL 是日志级别，比 ERROR 更高一级，类似 Python 中的 critical，无法使用的状态，所以当遇到这一行日志时，我就认为出现闪退了；\n第二步的实现思路为：逐行读取保存的日志文件，出现关键字就获取当前进程号，并添加到列表中，最后统计列表长度即可。\ndef get_crash_pid_list(file_path): \"\"\"读取日志，获取出现关键字（crash）的次数 \"\"\" keyword = \"FATAL EXCEPTION: main\" crash_pid = [] with open(file_path, encoding=\"utf-8\") as f: for line in f.readlines(): if keyword in line: # 提取出日志行内所有数字（日期 + PID） data = re.findall(r\"\\d+\", line) pid = data[-1] crash_pid.append(pid) logging.info(f\"Crash PID list  {crash_pid}\") return crash_pid 转储闪退日志 这里需要进行一次判断：\n 如果不存在闪退，直接给出提示，退出程序 如果存在，创建新的日志文件，写入设备信息，根据进程号提取日志  获取设备信息 日志提交后，被开发同学问过几次机型和系统，索性就直接加到日志里面吧\ndef get_device_info(device=\"\"): \"\"\"获取设备信息 \"\"\" model = os.popen(f\"adb {device} shell getprop ro.product.model\").read().strip() manufacturer = os.popen(f\"adb {device} shell getprop ro.product.manufacturer\").read().strip() version = os.popen(f\"adb {device} shell getprop ro.build.version.release\").read().strip() sdk_version = os.popen(f\"adb {device} shell getprop ro.build.version.sdk\").read().strip() output = f\"DeviceInfo: {manufacturer} {model} | Android {version} (API {sdk_version})\" return output 转存日志 逐行读取，匹配进程号，写入到新的日志文件内，如果不填，则走默认路径\ndef dump_crash_log(file_path=\"\", dump_path=\"\", device=\"\"): \"\"\"转储带有 crash pid 的日志 \"\"\" # 设置默认转储路径 if not file_path: file_path = \"logcat.log\" if not dump_path: dump_path = \"logcat_crash.log\" if device: device = f\"-s {device}\" log_cat(file_path, device) device_info = get_device_info(device) pid_list = get_crash_pid_list(file_path) if pid_list: # 创建转储日志并写入 with open(dump_path, \"w+\", encoding=\"utf-8\") as f: f.write(f\"{'-' * 50}\\n\") f.write(f\"{device_info}\\n共出现 {len(pid_list)} 次闪退\\n\") f.write(f\"{'-' * 50}\\n\") # 读取原始日志 with open(file_path, encoding=\"utf-8\") as f1: for line in f1.readlines(): for pid in pid_list: if pid in line: if \"FATAL\" in line: f.write(\"\\n# begging of crash --- \\n\") f.write(line) logging.info(f\"Crash log path: {dump_path}\") else: logging.info(f\"Not found 'FATAL EXCEPTION: main' in {file_path}\") if __name__ == '__main__': dump_crash_log()  最后执行效果如下：\n控制台输出\n[ I 201231 13:57:05 dump_crash_log:44 ] PID LIST  ['26997', '28084', '6964'] [ I 201231 13:57:05 dump_crash_log:88 ] Crash log path: logcat_crash.log 目录结构\n dump_crash_log.py logcat.log logcat_crash.log  日志内容\n-------------------------------------------------- DeviceInfo: HUAWEI ELE-AL00 | Android 10 (API 29) 共出现 3 次闪退 -------------------------------------------------- # begging of crash ---  11-02 17:39:58.802 E/AndroidRuntime(26997): FATAL EXCEPTION: main 11-02 17:39:58.802 E/AndroidRuntime(26997): Process: com.esbook.reader, PID: 26997 11-02 17:39:58.802 E/AndroidRuntime(26997): java.lang.IllegalArgumentException: 这是异常信息 11-02 17:39:58.802 E/AndroidRuntime(26997): at 这是堆栈信息 11-02 17:39:58.802 E/AndroidRuntime(26997): at 这是堆栈信息 ... # begging of crash ---  11-02 17:55:39.306 E/AndroidRuntime(28084): FATAL EXCEPTION: main 11-02 17:55:39.306 E/AndroidRuntime(28084): Process: com.esbook.reader, PID: 28084 11-02 17:55:39.306 E/AndroidRuntime(28084): java.lang.NullPointerException: 这是异常信息 11-02 17:55:39.306 E/AndroidRuntime(28084): at 这是堆栈信息 11-02 17:55:39.306 E/AndroidRuntime(28084): at 这是堆栈信息 ... # begging of crash ---  11-02 18:15:37.625 E/AndroidRuntime( 6964): FATAL EXCEPTION: main 11-02 18:15:37.625 E/AndroidRuntime( 6964): Process: com.esbook.reader, PID: 6964 11-02 18:15:37.625 E/AndroidRuntime( 6964): at 这是堆栈信息 11-02 18:15:37.625 E/AndroidRuntime( 6964): at 这是堆栈信息 ...  大功告成，这样提取日志就会方便许多啦！😄\n","wordCount":"1582","inLanguage":"en","datePublished":"2021-01-21T15:35:52+08:00","dateModified":"2021-01-21T15:35:52+08:00","author":[{"@type":"Person","name":"ABEE"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://abeelan.github.io/posts/tech/andorid/android-%E9%97%AA%E9%80%80%E6%97%A5%E5%BF%97%E6%8F%90%E5%8F%96%E7%9A%84%E5%89%AF%E6%9C%AC/"},"publisher":{"@type":"Organization","name":"ABEE","logo":{"@type":"ImageObject","url":"https://abeelan.github.io/img/favicon.ico"}}}</script></head><body id=top><script>(function(){let a,b=new RegExp("(^| )change-themes=([^;]*)(;|$)");(a=document.cookie.match(b))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark')):(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://abeelan.github.io/ accesskey=h title="ABEE (Alt + H)"><img src=https://abeelan.github.io/img/avatar.gif alt=logo aria-label=logo height=35>ABEE</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://abeelan.github.io/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://abeelan.github.io/tags title="🧩 标签"><span>🧩 标签</span></a></li><li><a href=https://abeelan.github.io/archives/ title="⏱️ 时间轴"><span>⏱️ 时间轴</span></a></li><li><a href=https://abeelan.github.io/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://abeelan.github.io/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}body{counter-reset:h2}h2{counter-reset:h3}h3{counter-reset:h4}h4{counter-reset:h5}article[autonumbering] h2:before{counter-increment:h2;content:counter(h2)". "}article[autonumbering] h3:before{counter-increment:h3;content:counter(h2)"." counter(h3)" "}article[autonumbering] h4:before{counter-increment:h4;content:counter(h2)"." counter(h3)"." counter(h4)" "}article[autonumbering] .toc ul{counter-reset:item}article[autonumbering] .toc li a:before{content:counters(item,".")" ";counter-increment:item}</style><article class=post autonumbering><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://abeelan.github.io/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://abeelan.github.io/posts/>📚 分类</a>&nbsp;»&nbsp;<a href=https://abeelan.github.io/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>Android - 闪退日志提取</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span><span>2021-01-21
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span><span>1582字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span><span>4分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span><span>ABEE
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span><span><span class=post-tags-meta><a href=https://abeelan.github.io/tags/android/ style=color:var(--secondary)!important>android</a></span></span></span></span>
<span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span><span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>&nbsp;&nbsp;</span></span>
<span id=post_meta_style_8><span class="fa fa-commenting-o"></span><span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://abeelan.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=='/'&&(finalUrl='/'+finalUrl),twikoo.getCommentsCount({envId:null,region:"ap-beijing",urls:[finalUrl],includeReply:!1}).then(function(a){let b=a[0].count;const c=document.getElementById("comment_count");c.innerText=b}).catch(function(a){console.error(a)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e8%8e%b7%e5%8f%96%e6%97%a5%e5%bf%97 aria-label=获取日志>获取日志</a></li><li><a href=#%e7%bb%9f%e8%ae%a1%e5%87%ba%e7%8e%b0%e9%97%aa%e9%80%80%e6%ac%a1%e6%95%b0 aria-label=统计出现闪退次数>统计出现闪退次数</a></li><li><a href=#%e8%bd%ac%e5%82%a8%e9%97%aa%e9%80%80%e6%97%a5%e5%bf%97 aria-label=转储闪退日志>转储闪退日志</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener('DOMContentLoaded',function(b){checkTocPosition(),elements=document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]'),activeElement=elements[0];const a=encodeURI(activeElement.getAttribute('id')).toLowerCase();document.querySelector(`.inner ul li a[href="#${a}"]`).classList.add('active')},!1),window.addEventListener('resize',function(a){checkTocPosition()},!1),window.addEventListener('scroll',()=>{activeElement=Array.from(elements).find(a=>{if(getOffsetTop(a)-window.pageYOffset>0&&getOffsetTop(a)-window.pageYOffset<window.innerHeight/2)return a})||activeElement,elements.forEach(a=>{const b=encodeURI(a.getAttribute('id')).toLowerCase();a===activeElement?document.querySelector(`.inner ul li a[href="#${b}"]`).classList.add('active'):document.querySelector(`.inner ul li a[href="#${b}"]`).classList.remove('active')})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue('--gap'),10);function checkTocPosition(){const a=document.body.scrollWidth;a-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(a){if(!a.getClientRects().length)return 0;let b=a.getBoundingClientRect(),c=a.ownerDocument.defaultView;return b.top+c.pageYOffset}</script><div class=post-content><p>安卓手机测试过程中，遇到应用闪退，通常需要在 <code>BUG</code> 信息上附加崩溃日志，便于开发同学快速定位问题。</p><p>存储日志命令为：
<code>adb logcat -v time > crash_log.log</code></p><p>这个方法抓到的日志过多，很多都是无用的系统日志或级别过低的打印日志，所以需要做一次过滤，<code>logcat</code> 可以根据日志等级过滤。将日志级别设置为 <code>ERROR</code>，就可以过滤掉一大部分无用信息。</p><p>命令修改为：
<code>adb logcat -v time *:E > crash_log.log</code></p><blockquote><p><strong>备注：</strong></p><ul><li>星号 <code>*</code> 代表日志任意 <code>tag</code> 都只输出 <code>Error</code> 级别以上日志；</li><li>MacOS 命令行直接使用 <code>*:E</code> 会报错 <code>no matches found: *:E</code>，所以需要添加双引号或转义符来解决：<code>"*:E"</code> 或 <code>\*:E</code></li></ul></blockquote><p>获取到日志后，会发现，还是存在一部分系统的错误日志，如何再次过滤呢？</p><p>目标：仅需要某个闪退的全部堆栈信息</p><p>思路：</p><ol><li>通过命令行做第一次过滤，获取到 <code>ERROR</code> 级别的原始日志；</li><li>逐行读取日志，如果查找到关键字 <code>FATAL EXCEPTION: main</code> 则代表出现一次闪退，记录该进程 <code>PID</code> 存储到列表内；</li><li>判断当 <code>PID</code> 列表非空时，创建日志文件，将该 <code>PID</code> 的所有日志写入到新文件内。</li></ol><p>这样就能满足需求了，接下来代码实现，验证效果。</p><h2 id=获取日志>获取日志<a hidden class=anchor aria-hidden=true href=#获取日志>#</a></h2><p>人工操作步骤为：命令行输入命令，获取日志后，<code>Ctrl+C</code> 关闭日志</p><p>代码也一样，实现方法：</p><ul><li>模拟命令行：<code>subprocess</code>模块</li><li>等待日志获取：安卓日志缓冲区一般为<code>64KB</code>，可以通过 <code>time.sleep()</code> 暂停程序 <code>5</code> 秒（可以自定义时间，我是感觉够用了）；</li><li><code>Ctrl+C</code>：通过命令杀死 <code>adb logcat</code> 进程</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>def log_cat(file_path, device=&#34;&#34;):
    &#34;&#34;&#34;获取 adb 日志
    &#34;&#34;&#34;
    command = rf&#34;adb {device} logcat -v time \*:E &gt; {file_path}&#34;
    subprocess.Popen(command, shell=True)
    time.sleep(5)
    try:
        if platform.system() == &#34;Darwin&#34; or &#34;Linux&#34;:
            subprocess.call(
                &#34;kill -9 $(ps -ef | grep &#39;adb logcat&#39; | sed -n 1p | awk &#39;{print $2}&#39;)&#34;,
                shell=True
            )
        else:
            # Windows 不知道能否生效，网上查的这个方法，没有机器测试
            subprocess.Popen(&#34;taskkill /F /IM adb.exe&#34;)
    except Exception as e:
        logging.warning(f&#34;Kill「adb logcat」called Exception，message：{e}&#34;)
</code></pre></div><h2 id=统计出现闪退次数>统计出现闪退次数<a hidden class=anchor aria-hidden=true href=#统计出现闪退次数>#</a></h2><p>关键字：闪退日志每次出现都会带一行关键字 <code>FATAL EXCEPTION: main</code>，<code>FATAL</code> 是日志级别，比 <code>ERROR</code> 更高一级，类似 Python 中的 <code>critical</code>，无法使用的状态，所以当遇到这一行日志时，我就认为出现闪退了；</p><p>第二步的实现思路为：逐行读取保存的日志文件，出现关键字就获取当前进程号，并添加到列表中，最后统计列表长度即可。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>def get_crash_pid_list(file_path):
    &#34;&#34;&#34;读取日志，获取出现关键字（crash）的次数
    &#34;&#34;&#34;
    keyword = &#34;FATAL EXCEPTION: main&#34;
    crash_pid = []

    with open(file_path, encoding=&#34;utf-8&#34;) as f:
        for line in f.readlines():
            if keyword in line:
                # 提取出日志行内所有数字（日期 + PID）
                data = re.findall(r&#34;\d+&#34;, line)  
                pid = data[-1]
                crash_pid.append(pid)
    logging.info(f&#34;Crash PID list &gt;&gt;&gt; {crash_pid}&#34;)
    return crash_pid
</code></pre></div><h2 id=转储闪退日志>转储闪退日志<a hidden class=anchor aria-hidden=true href=#转储闪退日志>#</a></h2><p>这里需要进行一次判断：</p><ul><li>如果不存在闪退，直接给出提示，退出程序</li><li>如果存在，创建新的日志文件，写入设备信息，根据进程号提取日志</li></ul><p><strong>获取设备信息</strong>
日志提交后，被开发同学问过几次机型和系统，索性就直接加到日志里面吧</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>def get_device_info(device=&#34;&#34;):
    &#34;&#34;&#34;获取设备信息
    &#34;&#34;&#34;
    model = os.popen(f&#34;adb {device} shell getprop ro.product.model&#34;).read().strip()
    manufacturer = os.popen(f&#34;adb {device} shell getprop ro.product.manufacturer&#34;).read().strip()

    version = os.popen(f&#34;adb {device} shell getprop ro.build.version.release&#34;).read().strip()
    sdk_version = os.popen(f&#34;adb {device} shell getprop ro.build.version.sdk&#34;).read().strip()

    output = f&#34;DeviceInfo: {manufacturer} {model} | Android {version} (API {sdk_version})&#34;
    return output
</code></pre></div><p><strong>转存日志</strong>
逐行读取，匹配进程号，写入到新的日志文件内，如果不填，则走默认路径</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>def dump_crash_log(file_path=&#34;&#34;, dump_path=&#34;&#34;, device=&#34;&#34;):
    &#34;&#34;&#34;转储带有 crash pid 的日志
    &#34;&#34;&#34;
    # 设置默认转储路径
    if not file_path:
        file_path = &#34;logcat.log&#34;
    if not dump_path:
        dump_path = &#34;logcat_crash.log&#34;
    if device:
        device = f&#34;-s {device}&#34;

    log_cat(file_path, device)
    device_info = get_device_info(device)
    pid_list = get_crash_pid_list(file_path)

    if pid_list:
        # 创建转储日志并写入
        with open(dump_path, &#34;w+&#34;, encoding=&#34;utf-8&#34;) as f:  
            f.write(f&#34;{&#39;-&#39; * 50}\n&#34;)
            f.write(f&#34;{device_info}\n共出现 {len(pid_list)} 次闪退\n&#34;)
            f.write(f&#34;{&#39;-&#39; * 50}\n&#34;)
            # 读取原始日志
            with open(file_path, encoding=&#34;utf-8&#34;) as f1:
                for line in f1.readlines():
                    for pid in pid_list:
                        if pid in line:
                            if &#34;FATAL&#34; in line:
                                f.write(&#34;\n# begging of crash --- &gt;&gt;&gt;\n&#34;)
                            f.write(line)
        logging.info(f&#34;Crash log path: {dump_path}&#34;)
    else:
        logging.info(f&#34;Not found &#39;FATAL EXCEPTION: main&#39; in {file_path}&#34;)

if __name__ == &#39;__main__&#39;:
    dump_crash_log()
</code></pre></div><hr><p>最后执行效果如下：</p><p><strong>控制台输出</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[ I 201231 13:57:05 dump_crash_log:44 ] PID LIST &gt;&gt;&gt; [&#39;26997&#39;, &#39;28084&#39;, &#39;6964&#39;]
[ I 201231 13:57:05 dump_crash_log:88 ] Crash log path: logcat_crash.log
</code></pre></div><p><strong>目录结构</strong></p><ul><li>dump_crash_log.py</li><li>logcat.log</li><li>logcat_crash.log</li></ul><p><strong>日志内容</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>--------------------------------------------------
DeviceInfo: HUAWEI ELE-AL00 | Android 10 (API 29)
共出现 3 次闪退
--------------------------------------------------

# begging of crash --- &gt;&gt;&gt;
11-02 17:39:58.802 E/AndroidRuntime(26997): FATAL EXCEPTION: main
11-02 17:39:58.802 E/AndroidRuntime(26997): Process: com.esbook.reader, PID: 26997
11-02 17:39:58.802 E/AndroidRuntime(26997): java.lang.IllegalArgumentException: 这是异常信息
11-02 17:39:58.802 E/AndroidRuntime(26997):     at 这是堆栈信息
11-02 17:39:58.802 E/AndroidRuntime(26997):     at 这是堆栈信息
...

# begging of crash --- &gt;&gt;&gt;
11-02 17:55:39.306 E/AndroidRuntime(28084): FATAL EXCEPTION: main
11-02 17:55:39.306 E/AndroidRuntime(28084): Process: com.esbook.reader, PID: 28084
11-02 17:55:39.306 E/AndroidRuntime(28084): java.lang.NullPointerException: 这是异常信息
11-02 17:55:39.306 E/AndroidRuntime(28084):     at 这是堆栈信息
11-02 17:55:39.306 E/AndroidRuntime(28084):     at 这是堆栈信息
...

# begging of crash --- &gt;&gt;&gt;
11-02 18:15:37.625 E/AndroidRuntime( 6964): FATAL EXCEPTION: main
11-02 18:15:37.625 E/AndroidRuntime( 6964): Process: com.esbook.reader, PID: 6964
11-02 18:15:37.625 E/AndroidRuntime( 6964):     at 这是堆栈信息
11-02 18:15:37.625 E/AndroidRuntime( 6964):     at 这是堆栈信息
...
</code></pre></div><hr><p>大功告成，这样提取日志就会方便许多啦！😄</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://abeelan.github.io/img/wechatpay.jpg alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://abeelan.github.io/img/alipay.jpg alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick="var qr=document.getElementById('QR');qr.style.opacity==='0'?qr.style.opacity='1':qr.style.opacity='0'">
<span>🧧 鼓励一下 🧧</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://abeelan.github.io/posts/tech/andorid/%E5%BF%AB%E5%BA%94%E7%94%A8%E6%B5%8B%E8%AF%95/><span class=title>« 上一页</span><br><span>Android - 快应用测试方法</span></a>
<a class=next href=https://abeelan.github.io/posts/tech/docker/docker-android/><span class=title>下一页 »</span><br><span></span></a></nav></footer></div><style>.comments_details summary::marker{font-size:20px;content:'👉展开评论';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'👇关闭评论';color:var(--content)}</style><div><details class=comments_details><summary style="cursor:pointer;margin:50px 0 20px;width:130px"><span style=font-size:20px;color:var(--content)>...</span></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script><script>twikoo.init({envId:null,el:"#tcomment",lang:'zh-CN',region:"ap-beijing",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://abeelan.github.io/ style=color:#939393>ABEE</a>
All Rights Reserved</span>
<a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0"></a></span>
<span id=busuanzi_container><span class="fa fa-user"></span><span id=busuanzi_value_site_uv></span><span class="fa fa-eye"></span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a><script>document.addEventListener('scroll',function(e){const a=document.getElementById("read_progress"),b=document.documentElement.scrollHeight,c=document.documentElement.clientHeight,d=document.documentElement.scrollTop||document.body.scrollTop;a.innerText=((d/(b-c)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.body.addEventListener('copy',function(a){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let b=a.clipboardData||window.clipboardData;if(b){a.preventDefault();let c=window.getSelection().toString()+'\r\n\n————————————————\r\n'+'版权声明：本文为「'+"ABEE"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。'+'\r\n原文链接：'+location.href,d=window.getSelection().toString()+'\r\n\n————————————————\r\n'+'版权声明：本文为「'+"ABEE"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。'+'\r\n原文链接：'+location.href;b.setData('text/html',c),b.setData('text/plain',d)}}})</script><script>document.querySelectorAll('pre > code').forEach(c=>{const d=c.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='📄 复制';function i(){a.innerText='👌🏻 已复制!',setTimeout(()=>{a.innerText='📄 复制'},2e3)}a.addEventListener('click',d=>{if('clipboard'in navigator){let a=c.textContent+'\r\n————————————————\r\n'+'版权声明：本文为「'+"ABEE"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。'+'\r\n原文链接：'+location.href;navigator.clipboard.writeText(a),i();return}const a=document.createRange();a.selectNodeContents(c);const b=window.getSelection();b.removeAllRanges(),b.addRange(a);try{document.execCommand('copy'),i()}catch(a){}b.removeRange(a)});let j=c.className.replaceAll("language-",""),b=document.createElement("div"),f=document.createElement("div"),g=document.createElement("div"),h=document.createElement("div"),e=document.createElement("div");e.innerText=j,b.setAttribute('class','mac-tool'),f.setAttribute('class','mac bb1'),g.setAttribute('class','mac bb2'),h.setAttribute('class','mac bb3'),e.setAttribute('class','language-type'),b.appendChild(f),b.appendChild(g),b.appendChild(h),b.appendChild(e),d.classList.contains("highlight")?(d.appendChild(a),d.appendChild(b)):d.parentNode.firstChild==d||(c.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(c.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a),d.appendChild(b)):(c.parentNode.appendChild(a),d.appendChild(b)))})</script><script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&($(this).css("width","135%"),$(this).css("border-top-right-radius","var(--radius)"))}).on("mouseout",function(){$(this).css("width","100%"),$(this).css("border-top-right-radius","unset")})</script></body></html>